<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bad Alibi — Daily Word Search (Local Safe Mode)</title>
  <style>
    :root{
      --bg:#f5f5f5; --text:#222; --muted:#666; --card:#fff; --accent:#111; --brand:#111;
      --border:#e7e7e7; --grid-size:12; --hint:#ffbf47;
      --radius:16px; --shadow:0 6px 18px rgba(0,0,0,.08);
    }
    :root[data-theme="dark"]{
      --bg:#0e0f12; --text:#e8e8e8; --muted:#a0a0a0; --card:#17181c; --accent:#fafafa; --brand:#0ea5e9;
      --border:#2a2c31; --shadow:0 6px 18px rgba(0,0,0,.55); --hint:#ffd166;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Segoe UI',system-ui,-apple-system,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .container{width:92%;max-width:1100px;margin:0 auto;padding:2rem 0}
    header{display:flex;flex-wrap:wrap;gap:1rem;align-items:center;justify-content:space-between;margin-bottom:1.25rem}
    .title{display:flex;align-items:center;gap:.75rem}
    .title h1{font-size:clamp(1.25rem,2.5vw,1.75rem);margin:.25rem 0}
    .badge{background:var(--brand);color:#fff;border-radius:999px;padding:.25rem .6rem;font-size:.8rem}
    .cards{display:grid;grid-template-columns:1.25fr .75fr;gap:1.25rem}
    @media (max-width: 900px){.cards{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);border:1px solid var(--border)}
    .card .head{padding:1rem;border-bottom:1px solid var(--border)}
    .card .body{padding:1rem}
    .grid{display:grid;grid-template-columns:repeat(var(--grid-size),1fr);gap:3px;user-select:none}
    .cell{aspect-ratio:1;border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:600}
    .bank{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:.5rem}
    .word{ padding:.4rem .6rem;border:1px dashed var(--border);border-radius:10px;font-weight:600;background:color-mix(in srgb, var(--card) 92%, var(--bg) 8%); }
    .meta{color:#666}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <span class="badge">Bad Alibi</span>
        <h1>Daily Word Search</h1>
      </div>
      <div class="meta" id="meta"></div>
    </header>

    <div class="cards">
      <section class="card">
        <div class="head"><strong>Local Safe Mode</strong> — no API, no promises, deterministic words.</div>
        <div class="body">
          <div id="grid" class="grid" aria-label="Word search grid" role="grid"></div>
          <p class="meta">If you see a letter grid, the page is healthy — the earlier “out of memory” came from the async code path.</p>
        </div>
      </section>
      <aside class="card">
        <div class="head"><strong>Word Bank</strong></div>
        <div class="body"><div id="bank" class="bank"></div></div>
      </aside>
    </div>
    <p class="meta">Seed: America/Chicago</p>
  </div>

<script>
/* ---------- settings ---------- */
const GRID_SIZE = 12;
const TIMEZONE = 'America/Chicago';

/* local fallback words (kept simple) */
const LOCAL_THEME = 'Nature';
const LOCAL_WORDS = ["OCEAN","TREE","ISLAND","MOUNTAIN","VOLCANO","FLOWER","DESERT","RIVER","WATERFALL","FOREST","CANYON","BEACH"];

/* rng + helpers (same as before) */
function rng(seed){let a=seed|0;return()=>{a=(a+0x6D2B79F5)|0;let t=Math.imul(a^a>>>15,a|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
function chicagoISO(){return new Intl.DateTimeFormat('en-CA',{timeZone:TIMEZONE,year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date())}
function choice(a,r){return a[Math.floor(r()*a.length)]}
const DIRS=[[1,0],[-1,0],[0,1],[0,-1],[1,1],[-1,-1],[1,-1],[-1,1]];
function empty(n){return Array.from({length:n},()=>Array(n).fill(null))}
function inb(x,y){return x>=0&&y>=0&&x<GRID_SIZE&&y<GRID_SIZE}
function place(grid,word,r){
  for(let t=0;t<400;t++){
    const d=choice(DIRS,r), sx=Math.floor(r()*GRID_SIZE), sy=Math.floor(r()*GRID_SIZE);
    const ex=sx+d[0]*(word.length-1), ey=sy+d[1]*(word.length-1);
    if(!inb(ex,ey)) continue;
    let ok=true, coords=[];
    for(let i=0;i<word.length;i++){
      const x=sx+d[0]*i, y=sy+d[1]*i, c=grid[y][x];
      if(c && c!==word[i]){ ok=false; break; } coords.push([x,y]);
    }
    if(!ok) continue;
    for(let i=0;i<word.length;i++){const x=sx+d[0]*i,y=sy+d[1]*i; grid[y][x]=word[i];}
    return coords;
  }
  return null;
}
function fill(grid,r){
  const A='A'.charCodeAt(0);
  for(let y=0;y<GRID_SIZE;y++) for(let x=0;x<GRID_SIZE;x++)
    if(!grid[y][x]) grid[y][x]=String.fromCharCode(A+Math.floor(r()*26));
  return grid;
}

/* guarded API call */
async function getDailyWordsFromAPI(){
  const url = `/worker/daily-words?ts=${Date.now()}`;
  try{
    const res = await fetch(url, { cache:'no-store' });
    const ct = (res.headers.get('content-type')||'').toLowerCase();
    const txt = await res.text();                       // read once
    if(!res.ok || !ct.includes('application/json')) return {ok:false, reason:`${res.status} ${ct}`, txt};
    const data = JSON.parse(txt);
    const words = Array.isArray(data?.words) ? data.words : [];
    const cleaned = [...new Set(words.map(w=>String(w).toUpperCase().trim()))].filter(w=>/^[A-Z]{3,20}$/.test(w));
    if(!cleaned.length) return {ok:false, reason:'empty words'};
    return {ok:true, theme: data.theme||'Animals', words: cleaned};
  }catch(e){
    return {ok:false, reason:String(e)};
  }
}

/* render puzzle with given words */
function render(theme, words){
  const r = rng(Number(chicagoISO().replace(/-/g,'')) ^ 0xBADA551);
  const meta=document.getElementById('meta');
  const gridEl=document.getElementById('grid');
  const bankEl=document.getElementById('bank');
  document.documentElement.style.setProperty('--grid-size', GRID_SIZE);

  meta.textContent = `Theme: ${theme} · Date: ${chicagoISO()}`;

  const grid = fill(words.reduce((g,w)=>{place(g,w,r);return g;}, empty(GRID_SIZE)), r);

  gridEl.innerHTML='';
  for(let y=0;y<GRID_SIZE;y++) for(let x=0;x<GRID_SIZE;x++){
    const d=document.createElement('div'); d.className='cell'; d.textContent=grid[y][x]; gridEl.appendChild(d);
  }
  bankEl.innerHTML = words.slice().sort().map(w=>`<div class="word">${w}</div>`).join('');
}

/* bootstrap */
(async function(){
  // try API, otherwise fall back
  const api = await getDailyWordsFromAPI();
  const banner = document.createElement('div');
  banner.style.cssText='margin:.25rem 0 0;color:#666;font-size:.9rem';

  if(api.ok){
    banner.textContent = `Using API — Theme: ${api.theme}`;
    document.getElementById('meta').after(banner);
    render(api.theme, api.words);
  }else{
    banner.textContent = `Using local fallback — Theme: ${LOCAL_THEME}`;
    document.getElementById('meta').after(banner);
    render(LOCAL_THEME, LOCAL_WORDS);
  }
})();
</script>

</body>
</html>
